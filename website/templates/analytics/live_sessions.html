<div class="container-fluid py-4">
    <h2 class="mb-4">Live Poker Sessions</h2>
    
    <!-- Add Session Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="fas fa-plus-circle me-2"></i>Add Live Session
            </h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('views.add_live_session') }}">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="session_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="session_date" name="session_date" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location" placeholder="Casino/Venue">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Game Type:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="cash" name="game_type" value="cash" checked>
                            <label class="form-check-label" for="cash">Cash Game</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" id="tournament" name="game_type" value="tournament">
                            <label class="form-check-label" for="tournament">Tournament</label>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="table_size" class="form-label">Table Size:</label>
                        <select class="form-select" id="table_size" name="table_size">
                            <option value="">Select table size</option>
                            <option value="6-max">6-max</option>
                            <option value="9-max">9-max</option>
                            <option value="full ring">Full Ring</option>
                            <option value="heads-up">Heads-up</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="game_name" class="form-label">Game Name:</label>
                        <input type="text" class="form-control" id="game_name" name="game_name" placeholder="e.g., Texas Hold'em">
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="stakes" class="form-label">Stakes</label>
                        <input type="text" class="form-control" id="stakes" name="stakes" placeholder="1/2" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="currency" class="form-label">Currency:</label>
                        <select class="form-select" id="currency" name="currency" disabled>
                            <option value="EUR" selected>EUR (€)</option>
                        </select>
                        <input type="hidden" name="currency" value="EUR">
                        <small class="text-muted">Live sessions use EUR</small>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="buy_in" class="form-label">Buy-in</label>
                        <input type="number" step="0.01" class="form-control" id="buy_in" name="buy_in" required>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="cash_out" class="form-label">Cash-out</label>
                        <input type="number" step="0.01" class="form-control" id="cash_out" name="cash_out" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="hours_played" class="form-label">Hours Played</label>
                        <input type="number" step="0.5" class="form-control" id="hours_played" name="hours_played" placeholder="Optional">
                    </div>
                    <div class="col-md-9 mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <input type="text" class="form-control" id="notes" name="notes" placeholder="Optional notes about the session">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Add Session
                </button>
            </form>
        </div>
    </div>
    
    <!-- Sessions Summary -->
    {% if live_sessions %}
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Sessions</h5>
                    <h3 class="mb-0">{{ live_sessions|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Profit/Loss</h5>
                    <h3 class="mb-0 {% if total_profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                        €{{ "%.2f"|format(total_profit_loss) }}
                    </h3>
                    {% if total_profit_loss_bb %}
                    <small class="text-muted">{{ "%.1f"|format(total_profit_loss_bb) }} BB</small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Win Rate</h5>
                    <h3 class="mb-0 {% if win_rate >= 50 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.1f"|format(win_rate) }}%
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Avg Profit/Session</h5>
                    <h3 class="mb-0 {% if avg_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                        €{{ "%.2f"|format(avg_profit) }}
                    </h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Hours</h5>
                    <h3 class="mb-0">{{ "%.1f"|format(total_hours) if total_hours else '0' }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title text-muted">Avg BB/Hour</h5>
                    <h3 class="mb-0 {% if avg_bb_per_hour and avg_bb_per_hour >= 0 %}text-success{% elif avg_bb_per_hour %}text-danger{% endif %}">
                        {% if avg_bb_per_hour is not none %}
                        {{ "%.2f"|format(avg_bb_per_hour) }}
                        {% else %}
                        -
                        {% endif %}
                    </h3>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sessions Table -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Session History</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Game Type</th>
                            <th>Table Size</th>
                            <th>Game Name</th>
                            <th>Stakes</th>
                            <th>Buy-in</th>
                            <th>Cash-out</th>
                            <th>Profit/Loss</th>
                            <th>P/L (BB)</th>
                            <th>Hours</th>
                            <th>BB/Hour</th>
                            <th>Currency</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in live_sessions %}
                        <tr>
                            <td>{{ session.session_date.strftime('%Y-%m-%d') }}</td>
                            <td>{{ session.location or '-' }}</td>
                            <td><span class="badge bg-secondary">{{ session.game_type|title if session.game_type else '-' }}</span></td>
                            <td>{{ session.table_size or '-' }}</td>
                            <td>{{ session.game_name or '-' }}</td>
                            <td><span class="badge bg-info">{{ session.stakes }}</span></td>
                            <td>€{{ "%.2f"|format(session.buy_in) }}</td>
                            <td>€{{ "%.2f"|format(session.cash_out) }}</td>
                            <td class="{% if session.profit_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                                <strong>€{{ "%.2f"|format(session.profit_loss) }}</strong>
                            </td>
                            <td class="{% if session.profit_loss_bb and session.profit_loss_bb >= 0 %}text-success{% elif session.profit_loss_bb %}text-danger{% endif %}">
                                {% if session.profit_loss_bb is not none %}
                                <strong>{{ "%.1f"|format(session.profit_loss_bb) }} BB</strong>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ "%.1f"|format(session.hours_played) if session.hours_played else '-' }}</td>
                            <td class="{% if session.bb_per_hour and session.bb_per_hour >= 0 %}text-success{% elif session.bb_per_hour %}text-danger{% endif %}">
                                {% if session.bb_per_hour is not none %}
                                <strong>{{ "%.2f"|format(session.bb_per_hour) }} BB/hr</strong>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>EUR (€)</td>
                            <td>{{ session.notes or '-' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="editSession({{ session.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="{{ url_for('views.delete_live_session', session_id=session.id) }}" 
                                   class="btn btn-sm btn-outline-danger"
                                   onclick="return confirm('Are you sure you want to delete this session?');">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <h4>No Live Sessions Recorded</h4>
        <p>Start tracking your live poker sessions by adding your first session above.</p>
    </div>
    {% endif %}
</div>

<!-- Edit Session Modal -->
<div class="modal fade" id="editSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Live Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="" id="editSessionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_session_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="edit_session_date" name="session_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="edit_location" name="location">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Game Type:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="edit_cash" name="game_type" value="cash">
                                <label class="form-check-label" for="edit_cash">Cash Game</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" id="edit_tournament" name="game_type" value="tournament">
                                <label class="form-check-label" for="edit_tournament">Tournament</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_table_size" class="form-label">Table Size:</label>
                            <select class="form-select" id="edit_table_size" name="table_size">
                                <option value="">Select table size</option>
                                <option value="6-max">6-max</option>
                                <option value="9-max">9-max</option>
                                <option value="full ring">Full Ring</option>
                                <option value="heads-up">Heads-up</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_game_name" class="form-label">Game Name:</label>
                            <input type="text" class="form-control" id="edit_game_name" name="game_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_stakes" class="form-label">Stakes</label>
                            <input type="text" class="form-control" id="edit_stakes" name="stakes" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="edit_currency" class="form-label">Currency:</label>
                            <select class="form-select" id="edit_currency" name="currency" disabled>
                                <option value="EUR" selected>EUR (€)</option>
                            </select>
                            <input type="hidden" name="currency" value="EUR">
                            <small class="text-muted">Live sessions use EUR</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit_buy_in" class="form-label">Buy-in</label>
                            <input type="number" step="0.01" class="form-control" id="edit_buy_in" name="buy_in" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="edit_cash_out" class="form-label">Cash-out</label>
                            <input type="number" step="0.01" class="form-control" id="edit_cash_out" name="cash_out" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_hours_played" class="form-label">Hours Played</label>
                            <input type="number" step="0.5" class="form-control" id="edit_hours_played" name="hours_played">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_notes" class="form-label">Notes</label>
                            <input type="text" class="form-control" id="edit_notes" name="notes">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editSession(sessionId) {
    // Fetch session data and populate modal
    fetch(`/get-live-session/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_session_date').value = data.session_date;
            document.getElementById('edit_location').value = data.location || '';
            document.getElementById('edit_game_name').value = data.game_name || '';
            document.getElementById('edit_table_size').value = data.table_size || '';
            document.getElementById('edit_currency').value = 'EUR';  // Live sessions always use EUR
            document.getElementById('edit_stakes').value = data.stakes;
            document.getElementById('edit_buy_in').value = data.buy_in;
            document.getElementById('edit_cash_out').value = data.cash_out;
            document.getElementById('edit_hours_played').value = data.hours_played || '';
            document.getElementById('edit_notes').value = data.notes || '';
            
            // Set game type radio button
            if (data.game_type === 'tournament') {
                document.getElementById('edit_tournament').checked = true;
            } else {
                document.getElementById('edit_cash').checked = true;
            }
            
            document.getElementById('editSessionForm').action = `/edit-live-session/${sessionId}`;
            
            const modal = new bootstrap.Modal(document.getElementById('editSessionModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading session data');
        });
}
</script>

