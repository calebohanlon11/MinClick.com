<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arithmetic Quiz</title>
    <style>
        .d-flex {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .question-container {
            margin-top: 20px;
        }
        .question {
            font-size: 1.5em;
        }
        .timer {
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex">
            <button id="start-btn" class="btn btn-primary" onclick="startQuiz()">Start 1 Questions</button>
            <div class="timer" id="timer">Last Time: 0s</div>
        </div>
        <div class="question-container">
            <div class="question" id="question"></div>
            <input type="text" id="answer" oninput="checkAnswer()">
        </div>
        <div class="d-flex" id="submit-container" style="display: none;">
            <button id="submit-btn" class="btn btn-success" onclick="submitResults()">Submit</button>
        </div>
    </div>

    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let startTime;
        let questionStartTime;
        let results = [];
        let quizCompleted = false;  // Variable to track quiz completion

        function generateQuestion() {
            const operations = ['+', '-', '*', '/'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            let question, answer;
            let num1, num2;

            switch (operation) {
                case '+':
                    num1 = Math.floor(Math.random() * 10000) + 1;
                    num2 = Math.floor(Math.random() * 1000) + 1;
                    question = `${num1} + ${num2}`;
                    answer = num1 + num2;
                    break;
                case '-':
                    num1 = Math.floor(Math.random() * 10000) + 1;
                    num2 = Math.floor(Math.random() * num1) + 1;
                    question = `${num1} - ${num2}`;
                    answer = num1 - num2;
                    break;
                case '*':
                    num1 = Math.floor(Math.random() * 1000) + 1;
                    num2 = Math.floor(Math.random() * 100) + 1;
                    question = `${num1} * ${num2}`;
                    answer = num1 * num2;
                    break;
                case '/':
                    num2 = Math.floor(Math.random() * 99) + 1;
                    num1 = num2 * (Math.floor(Math.random() * (10000 / num2)) + 1);
                    question = `${num1} / ${num2}`;
                    answer = num1 / num2;
                    break;
            }
            return { question, answer, type: operation };
        }

        function startQuiz() {
            questions = [];
            results = [];
            quizCompleted = false;
            document.getElementById('submit-container').style.display = 'none';  // Hide submit button
            for (let i = 0; i < 1; i++) {
                questions.push(generateQuestion());
            }
            currentQuestionIndex = 0;
            startTime = Date.now();
            document.getElementById('start-btn').disabled = true;
            document.getElementById('answer').disabled = false;
            document.getElementById('answer').focus();
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById('question').innerText = questions[currentQuestionIndex].question;
                document.getElementById('answer').value = '';
                questionStartTime = Date.now();
            } else {
                endQuiz();
            }
        }

        function checkAnswer() {
            const answer = document.getElementById('answer').value;
            if (parseFloat(answer) == questions[currentQuestionIndex].answer) {
                const timeTaken = (Date.now() - questionStartTime) / 1000;
                results.push({
                    question: questions[currentQuestionIndex].question,
                    type: questions[currentQuestionIndex].type,
                    timeTaken: timeTaken
                });
                currentQuestionIndex++;
                showQuestion();
            }
        }

        function endQuiz() {
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').innerText = `Time: ${totalTime}s`;
            localStorage.setItem('lastTime', totalTime);
            document.getElementById('start-btn').disabled = false;
            document.getElementById('answer').disabled = true;
            alert(`Quiz finished! Total time: ${totalTime} seconds.`);
            document.getElementById('submit-container').style.display = 'flex';  // Show submit button
            quizCompleted = true;
        }

        function submitResults() {
            if (quizCompleted) {
                fetch('/save_results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ results: results, userId: {{ current_user.id|tojson }} }),
                }).then(response => response.json()).then(data => {
                    console.log('Success:', data);
                    location.reload();  // Reload the page
                }).catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert('Finish the quiz first!');
            }
        }
    </script>
</body>
</html>
