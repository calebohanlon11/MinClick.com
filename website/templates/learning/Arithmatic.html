<style>
    .arith-quiz-card {
        border-radius: 16px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .arith-stat {
        border-radius: 12px;
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #eef0f2;
    }
    [data-theme="dark"] .arith-stat {
        background: #1f1f1f;
        border-color: #2b2b2b;
    }
    .arith-question {
        font-size: 1.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    .arith-input {
        font-size: 1.25rem;
        text-align: center;
    }
</style>

<div class="container my-4">
    <div class="card arith-quiz-card">
        <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
                <div>
                    <h3 class="mb-1">Arithmetic Speed Drill</h3>
                    <p class="text-muted mb-0">Short calculation sprints to sharpen fundamentals.</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="start-btn" class="btn btn-primary btn-lg" onclick="startQuiz()">
                        <i class="fas fa-play me-1"></i>Start 1 Question
                    </button>
                    <button id="submit-btn" class="btn btn-success btn-lg" onclick="submitResults()" style="display: none;">
                        <i class="fas fa-save me-1"></i>Submit
                    </button>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="arith-stat">
                        <div class="text-muted small">Last Time</div>
                        <div class="fs-4 fw-semibold" id="last-time">0s</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="arith-stat">
                        <div class="text-muted small">Current Time</div>
                        <div class="fs-4 fw-semibold" id="timer">0s</div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <div class="arith-question mb-2" id="question">Press start to begin</div>
                <div class="text-muted mb-3" id="progress">Question 0 of 0</div>
                <input type="text" id="answer" class="form-control arith-input mx-auto" style="max-width: 320px;" placeholder="Type answer..." oninput="checkAnswer()" disabled>
                <div class="mt-3">
                    <button id="next-btn" class="btn btn-outline-secondary" onclick="nextQuestion()" disabled>
                        Next Question
                    </button>
                    <button id="show-answer-btn" class="btn btn-outline-primary ms-2" onclick="showAnswer()" disabled>
                        Show Answer
                    </button>
                </div>
                <div class="mt-2 text-muted" id="answer-reveal" style="display: none;"></div>
                <div class="mt-1 text-muted" id="formula-reveal" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
        let questions = [];
        let currentQuestionIndex = 0;
        let startTime;
        let questionStartTime;
        let results = [];
        let quizCompleted = false;  // Variable to track quiz completion
        let timerInterval;
        const totalQuestions = 10;
        let correctCount = 0;
        let revealedAnswer = false;

        function generateQuestion() {
            const operations = ['+', '-', '*', '/'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            let question, answer;
            let num1, num2;

            switch (operation) {
                case '+':
                    num1 = Math.floor(Math.random() * 10000) + 1;
                    num2 = Math.floor(Math.random() * 1000) + 1;
                    question = `${num1} + ${num2}`;
                    answer = num1 + num2;
                    break;
                case '-':
                    num1 = Math.floor(Math.random() * 10000) + 1;
                    num2 = Math.floor(Math.random() * num1) + 1;
                    question = `${num1} - ${num2}`;
                    answer = num1 - num2;
                    break;
                case '*':
                    num1 = Math.floor(Math.random() * 1000) + 1;
                    num2 = Math.floor(Math.random() * 100) + 1;
                    question = `${num1} * ${num2}`;
                    answer = num1 * num2;
                    break;
                case '/':
                    num2 = Math.floor(Math.random() * 99) + 1;
                    num1 = num2 * (Math.floor(Math.random() * (10000 / num2)) + 1);
                    question = `${num1} / ${num2}`;
                    answer = num1 / num2;
                    break;
            }
            return { question, answer, type: operation };
        }

        function startQuiz() {
            questions = [];
            results = [];
            quizCompleted = false;
            correctCount = 0;
            revealedAnswer = false;
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('answer-reveal').style.display = 'none';
            document.getElementById('formula-reveal').style.display = 'none';
            for (let i = 0; i < totalQuestions; i++) {
                questions.push(generateQuestion());
            }
            currentQuestionIndex = 0;
            startTime = Date.now();
            document.getElementById('timer').innerText = '0s';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('answer').disabled = false;
            document.getElementById('next-btn').disabled = false;
            document.getElementById('show-answer-btn').disabled = false;
            document.getElementById('answer').focus();
            startTimer();
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex < questions.length) {
                document.getElementById('question').innerText = questions[currentQuestionIndex].question;
                document.getElementById('progress').innerText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
                document.getElementById('answer').value = '';
                document.getElementById('answer-reveal').style.display = 'none';
                document.getElementById('formula-reveal').style.display = 'none';
                revealedAnswer = false;
                questionStartTime = Date.now();
            } else {
                endQuiz();
            }
        }

        function checkAnswer() {
            const answer = document.getElementById('answer').value;
            if (parseFloat(answer) == questions[currentQuestionIndex].answer) {
                recordAnswerAndAdvance();
            }
        }

        function nextQuestion() {
            const answer = document.getElementById('answer').value;
            if (parseFloat(answer) == questions[currentQuestionIndex].answer) {
                recordAnswerAndAdvance();
            } else {
                alert('Answer is incorrect. Try again.');
            }
        }

        function recordAnswerAndAdvance() {
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            if (!revealedAnswer) {
                correctCount += 1;
            }
            results.push({
                question: questions[currentQuestionIndex].question,
                type: questions[currentQuestionIndex].type,
                timeTaken: timeTaken,
                correct: !revealedAnswer
            });
            currentQuestionIndex++;
            showQuestion();
        }

        function showAnswer() {
            const reveal = document.getElementById('answer-reveal');
            if (currentQuestionIndex < questions.length) {
                const questionText = questions[currentQuestionIndex].question;
                const answerValue = questions[currentQuestionIndex].answer;
                reveal.innerText = `Answer: ${answerValue}`;
                reveal.style.display = 'block';
                const formula = document.getElementById('formula-reveal');
                formula.innerText = `Formula: ${questionText} = ${answerValue}`;
                formula.style.display = 'block';
                revealedAnswer = true;
            }
        }

        function endQuiz() {
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').innerText = `Time: ${totalTime}s`;
            localStorage.setItem('lastTime', totalTime);
            document.getElementById('start-btn').disabled = false;
            document.getElementById('answer').disabled = true;
            document.getElementById('next-btn').disabled = true;
            document.getElementById('show-answer-btn').disabled = true;
            alert(`Quiz finished! Total time: ${totalTime} seconds.`);
            document.getElementById('submit-btn').style.display = 'inline-flex';
            quizCompleted = true;
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').innerText = `${elapsed}s`;
            }, 250);
        }

        function submitResults() {
            if (quizCompleted) {
                const scoreOutOf10 = Math.round((correctCount / totalQuestions) * 100) / 10;
                fetch('/save_results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        results: results,
                        total_time: Math.floor((Date.now() - startTime) / 1000),
                        correct_count: correctCount,
                        total_questions: totalQuestions,
                        score_out_of_10: scoreOutOf10
                    }),
                }).then(response => response.json()).then(data => {
                    console.log('Success:', data);
                    location.reload();  // Reload the page
                }).catch((error) => {
                    console.error('Error:', error);
                });
            } else {
                alert('Finish the quiz first!');
            }
        }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const lastTime = localStorage.getItem('lastTime');
        document.getElementById('last-time').innerText = lastTime ? `${lastTime}s` : '0s';
        const answerInput = document.getElementById('answer');
        answerInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                checkAnswer();
            }
        });
    });
</script>
