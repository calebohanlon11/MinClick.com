<style>
    .quant-card {
        border-radius: 16px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .quant-stat {
        border-radius: 12px;
        padding: 12px 16px;
        background: #f8f9fa;
        border: 1px solid #eef0f2;
    }
    [data-theme="dark"] .quant-stat {
        background: #1f1f1f;
        border-color: #2b2b2b;
    }
    .quant-question {
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.5;
    }
</style>

<div class="container my-4">
    <div class="card quant-card">
        <div class="card-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
                <div>
                    <h3 class="mb-1">Quant Math Quiz</h3>
                    <p class="text-muted mb-0">Timed drills for Bayes, EV, Options, and Coupon Collector.</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="restart-quiz" class="btn btn-outline-secondary btn-lg" style="display: none;">
                        <i class="fas fa-rotate-right me-1"></i>Restart
                    </button>
                    <button id="start-quiz" class="btn btn-primary btn-lg">
                        <i class="fas fa-play me-1"></i>Start Quiz
                    </button>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="quant-stat">
                        <div class="text-muted small">Total Time</div>
                        <div class="fs-4 fw-semibold" id="total-time">00:00</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="quant-stat">
                        <div class="text-muted small">Current Question Time</div>
                        <div class="fs-4 fw-semibold" id="question-time">00:00</div>
                    </div>
                </div>
            </div>

            <div id="question-box" style="display: none;">
                <p id="question-text" class="quant-question"></p>
                <input type="text" id="answer-input" class="form-control form-control-lg" placeholder="Type your answer here...">
                <div class="mt-3 text-end">
                    <button id="next-question" class="btn btn-outline-secondary">Next Question</button>
                    <button id="show-answer" class="btn btn-outline-primary ms-2">Show Answer</button>
                </div>
                <div class="mt-2 text-muted" id="answer-reveal" style="display: none;"></div>
                <div class="mt-1 text-muted" id="formula-reveal" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
    let questions = {};
    let currentCategoryIndex = 0;
    let currentQuestionIndex = 0;
    let categories = [];
    let currentAnswer = null;
    let totalQuestions = 0;
    let correctCount = 0;
    let revealedAnswer = false;

    let totalTime = 0;
    let questionTime = 0;
    let bayesTime = 0;
    let evTime = 0;
    let optionTime = 0;
    let couponTime = 0;
    let totalTimer, questionTimer;

    const startButton = document.getElementById('start-quiz');
    const restartButton = document.getElementById('restart-quiz');
    const questionBox = document.getElementById('question-box');
    const questionText = document.getElementById('question-text');
    const answerInput = document.getElementById('answer-input');
    const totalTimeDisplay = document.getElementById('total-time');
    const questionTimeDisplay = document.getElementById('question-time');
    const nextQuestionButton = document.getElementById('next-question');
    const showAnswerButton = document.getElementById('show-answer');
    const answerReveal = document.getElementById('answer-reveal');
    const formulaReveal = document.getElementById('formula-reveal');

    startButton.addEventListener('click', function() {
        startQuiz();
    });

    restartButton.addEventListener('click', function() {
        location.reload();
    });

    answerInput.addEventListener('input', function() {
        const userAnswer = parseFloat(answerInput.value);
        if (userAnswer === currentAnswer) {
            recordAnswerAndAdvance();
        }
    });

    function startQuiz() {
        startButton.style.display = 'none';
        restartButton.style.display = 'inline-block';
        questionBox.style.display = 'block';

        fetchQuestions();
        startTimers();
    }

    function fetchQuestions() {
        fetch('/get_quant_questions')
            .then(response => response.json())
            .then(data => {
                questions = data;
                categories = Object.keys(questions);
                totalQuestions = categories.reduce((sum, category) => {
                    return sum + Object.keys(questions[category]).length;
                }, 0);
                correctCount = 0;
                loadNextQuestion();
            })
            .catch(error => {
                console.error("Error fetching questions:", error);
            });
    }

    function loadNextQuestion() {
        if (currentCategoryIndex < categories.length) {
            const category = categories[currentCategoryIndex];
            const answers = Object.keys(questions[category]);

            if (currentQuestionIndex < answers.length) {
                currentAnswer = parseFloat(answers[currentQuestionIndex]);
                questionText.textContent = questions[category][answers[currentQuestionIndex]] || 'Error: No question found';
                resetQuestionTimer();
                answerInput.value = '';
                answerReveal.style.display = 'none';
                formulaReveal.style.display = 'none';
                revealedAnswer = false;
                answerInput.focus();
            } else {
                currentCategoryIndex++;
                currentQuestionIndex = 0;
                loadNextQuestion();
            }
        } else {
            stopTimers();
            questionBox.style.display = 'none';
            restartButton.style.display = 'none';

            // Save the results at the end of the quiz
            saveResults().then(() => {
                startButton.style.display = 'inline-block';
                startButton.textContent = 'Start Quiz';
            });
        }
    }

    answerInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const userAnswer = parseFloat(answerInput.value);
            const normalizedCurrentAnswer = currentAnswer % 1 === 0 ? currentAnswer.toFixed(0) : currentAnswer;
            if (userAnswer === parseFloat(normalizedCurrentAnswer)) {
                recordAnswerAndAdvance();
            }
        }
    });

    nextQuestionButton.addEventListener('click', function() {
        const userAnswer = parseFloat(answerInput.value);
        const normalizedCurrentAnswer = currentAnswer % 1 === 0 ? currentAnswer.toFixed(0) : currentAnswer;
        if (userAnswer === parseFloat(normalizedCurrentAnswer)) {
            recordAnswerAndAdvance();
        } else {
            alert('Answer is incorrect. Try again.');
        }
    });

    showAnswerButton.addEventListener('click', function() {
        if (currentAnswer === null) {
            return;
        }
        const normalizedCurrentAnswer = currentAnswer % 1 === 0 ? currentAnswer.toFixed(0) : currentAnswer;
        answerReveal.textContent = `Answer: ${normalizedCurrentAnswer}`;
        answerReveal.style.display = 'block';
        const category = categories[currentCategoryIndex] || '';
        const formulas = {
            'Bayes': 'P(A|B) = P(B|A) × P(A) / P(B)',
            'EV': 'EV = Σ (probability × outcome)',
            'Options': 'Value = max(0, S - K)',
            'CouponCollector': 'E[T] ≈ n × H_n'
        };
        formulaReveal.textContent = `Formula: ${formulas[category] || 'See question context'}`;
        formulaReveal.style.display = 'block';
        revealedAnswer = true;
    });




    function saveCurrentQuestionTime() {
        const category = categories[currentCategoryIndex];
        switch (category) {
            case 'Bayes':
                bayesTime += questionTime;
                break;
            case 'EV':
                evTime += questionTime;
                break;
            case 'Options':
                optionTime += questionTime;
                break;
            case 'CouponCollector':
                couponTime += questionTime;
                break;
        }
    }

    function recordAnswerAndAdvance() {
        if (!revealedAnswer) {
            correctCount += 1;
        }
        saveCurrentQuestionTime();
        currentQuestionIndex++;
        loadNextQuestion();
    }

    function saveResults() {
        const scoreOutOf10 = totalQuestions ? Math.round((correctCount / totalQuestions) * 100) / 10 : 0;
        fetch('/save_quant_test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                total_time: totalTime,
                bayes_time: bayesTime,
                coupon_time: couponTime,
                option_time: optionTime,
                ev_time: evTime,
                correct_count: correctCount,
                total_questions: totalQuestions,
                score_out_of_10: scoreOutOf10
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error("Failed to save results:", data.error);
            }
        })
        .catch(error => {
            console.error("Error saving results:", error);
        });
    }

    function startTimers() {
        totalTimer = setInterval(() => {
            totalTime++;
            updateTimerDisplay(totalTimeDisplay, totalTime);
        }, 1000);

        questionTimer = setInterval(() => {
            questionTime++;
            updateTimerDisplay(questionTimeDisplay, questionTime);
        }, 1000);
    }

    function resetQuestionTimer() {
        questionTime = 0;
        updateTimerDisplay(questionTimeDisplay, questionTime);
    }

    function stopTimers() {
        clearInterval(totalTimer);
        clearInterval(questionTimer);
    }

    function updateTimerDisplay(element, time) {
        const minutes = String(Math.floor(time / 60)).padStart(2, '0');
        const seconds = String(time % 60).padStart(2, '0');
        element.textContent = `${minutes}:${seconds}`;
    }
});
</script>
