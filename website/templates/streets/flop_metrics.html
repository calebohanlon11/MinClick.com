{% block metrics %}
<h2>Flop Metrics</h2>

<!-- Key Metric: Total Flops Played -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h3 class="mb-0"><i class="fas fa-chart-line me-2"></i>Key Metrics</h3>
    </div>
    <div class="card-body">
        {% set action_freq = metrics.get('Flop Action Frequency') %}
        {% if action_freq is not none %}
            {% if action_freq is mapping %}
                {% set ip = action_freq.get('ip', {}) if action_freq.get('ip') is mapping else {} %}
                {% set oop = action_freq.get('oop', {}) if action_freq.get('oop') is mapping else {} %}
                {% set mw = action_freq.get('multiway', {}) if action_freq.get('multiway') is mapping else {} %}
                {% set derived_total = (ip.get('total', 0) | int) + (oop.get('total', 0) | int) + (mw.get('total', 0) | int) %}
                {% set total_flops = derived_total if derived_total > 0 else action_freq.get('total_hands', 0) %}
            {% else %}
                {% set total_flops = 0 %}
            {% endif %}
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4 class="text-primary mb-1">{{ total_flops }}</h4>
                            <p class="text-muted mb-0">Total Flops Played</p>
                        </div>
                    </div>
                </div>
                {% if metrics.get('IP Profitability') is not none and metrics.get('OP Profitability') is not none %}
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4 class="{% if metrics.get('IP Profitability', 0) >= 0 %}text-success{% else %}text-danger{% endif %} mb-1">
                                {{ "%.2f"|format(metrics.get('IP Profitability', 0)) }} BB
                            </h4>
                            <p class="text-muted mb-0">IP Profitability</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4 class="{% if metrics.get('OP Profitability', 0) >= 0 %}text-success{% else %}text-danger{% endif %} mb-1">
                                {{ "%.2f"|format(metrics.get('OP Profitability', 0)) }} BB
                            </h4>
                            <p class="text-muted mb-0">OP Profitability</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if metrics.get('In Position Percentage') is not none %}
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h4 class="text-info mb-1">{{ "%.1f"|format(metrics.get('In Position Percentage', 0)) }}%</h4>
                            <p class="text-muted mb-0">In Position %</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Flop Action Frequency Breakdown -->
            <div class="row">
                <div class="col-12">
                    <h4 class="mb-3">Flop Action Frequency</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Category</th>
                                    <th>Total Hands</th>
                                    <th>Checks</th>
                                    <th>Bets</th>
                                    <th>Calls</th>
                                    <th>Raises</th>
                                    <th>Folds</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if action_freq is mapping %}
                                {% set ip = action_freq.get('ip', {}) if action_freq.get('ip') is mapping else {'total': 0, 'checks': 0, 'bets': 0, 'calls': 0, 'folds': 0, 'raises': 0} %}
                                <tr>
                                    <td><strong>In Position (IP)</strong></td>
                                    <td>{{ ip.get('total', 0) }}</td>
                                    <td>{{ ip.get('checks', 0) }}</td>
                                    <td>{{ ip.get('bets', 0) }}</td>
                                    <td>{{ ip.get('calls', 0) }}</td>
                                    <td>{{ ip.get('raises', 0) }}</td>
                                    <td>{{ ip.get('folds', 0) }}</td>
                                </tr>
                                {% set oop = action_freq.get('oop', {}) if action_freq.get('oop') is mapping else {'total': 0, 'checks': 0, 'bets': 0, 'calls': 0, 'folds': 0, 'raises': 0} %}
                                <tr>
                                    <td><strong>Out of Position (OOP)</strong></td>
                                    <td>{{ oop.get('total', 0) }}</td>
                                    <td>{{ oop.get('checks', 0) }}</td>
                                    <td>{{ oop.get('bets', 0) }}</td>
                                    <td>{{ oop.get('calls', 0) }}</td>
                                    <td>{{ oop.get('raises', 0) }}</td>
                                    <td>{{ oop.get('folds', 0) }}</td>
                                </tr>
                                {% set mw = action_freq.get('multiway', {}) if action_freq.get('multiway') is mapping else {'total': 0, 'checks': 0, 'bets': 0, 'calls': 0, 'folds': 0, 'raises': 0} %}
                                <tr>
                                    <td><strong>Multiway (3+ players)</strong></td>
                                    <td>{{ mw.get('total', 0) }}</td>
                                    <td>{{ mw.get('checks', 0) }}</td>
                                    <td>{{ mw.get('bets', 0) }}</td>
                                    <td>{{ mw.get('calls', 0) }}</td>
                                    <td>{{ mw.get('raises', 0) }}</td>
                                    <td>{{ mw.get('folds', 0) }}</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <p class="text-muted mb-0">No flop data available. Please reprocess this post.</p>
        {% endif %}
    </div>
</div>

<!-- Flop High Card Analysis -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h3>Flop High Card Analysis</h3>
            <p class="text-muted mb-0">BB earnings by highest card on the flop</p>
        </div>
        <div class="mt-2 mt-md-0">
            <label for="flop-highcard-sort" class="form-label me-2 mb-0">Sort by:</label>
            <select id="flop-highcard-sort" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                <option value="rank">Card Rank (A to 2)</option>
                <option value="hands-desc">Total Hands (High to Low)</option>
                <option value="hands-asc">Total Hands (Low to High)</option>
                <option value="bb-desc">Total BB Earnings (High to Low)</option>
                <option value="bb-asc">Total BB Earnings (Low to High)</option>
                <option value="avg-desc">Avg BB/Hand (High to Low)</option>
                <option value="avg-asc">Avg BB/Hand (Low to High)</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        {% if metrics.get('Flop High Card Analysis') %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="flop-highcard-table">
                    <thead>
                        <tr>
                            <th>Flop High Card</th>
                            <th>Total Hands</th>
                            <th>Total BB Earnings</th>
                            <th>Avg BB/Hand</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for flop_type, data in metrics.get('Flop High Card Analysis', {}).items() %}
                        <tr class="{% if data.get('total_bb_earnings', 0) < 0 %}table-danger{% elif data.get('total_bb_earnings', 0) > 0 %}table-success{% endif %}"
                            data-high-card="{{ flop_type }}"
                            data-total-hands="{{ data.get('total_hands', 0) }}"
                            data-total-bb="{{ data.get('total_bb_earnings', 0) }}"
                            data-avg-bb="{{ data.get('avg_bb_per_hand', 0) }}">
                            <td><strong>{{ flop_type }}</strong></td>
                            <td>{{ data.get('total_hands', 0) }}</td>
                            <td class="{% if data.get('total_bb_earnings', 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(data.get('total_bb_earnings', 0)) }} BB
                            </td>
                            <td class="{% if data.get('avg_bb_per_hand', 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(data.get('avg_bb_per_hand', 0)) }} BB
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <script>
            (function() {
                const sortSelect = document.getElementById('flop-highcard-sort');
                const table = document.getElementById('flop-highcard-table');
                if (!sortSelect || !table) return;
                
                const rankOrder = ['A High','K High','Q High','J High','T High','9 High','8 High','7 High','6 High','5 High','4 High','3 High','2 High'];
                function getRankIndex(label) {
                    const idx = rankOrder.indexOf(label);
                    return idx === -1 ? rankOrder.length : idx;
                }
                
                function sortTable() {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const sortValue = sortSelect.value;
                    
                    rows.sort((a, b) => {
                        if (sortValue === 'rank') {
                            return getRankIndex(a.dataset.highCard) - getRankIndex(b.dataset.highCard);
                        } else if (sortValue === 'hands-desc') {
                            return parseFloat(b.dataset.totalHands) - parseFloat(a.dataset.totalHands);
                        } else if (sortValue === 'hands-asc') {
                            return parseFloat(a.dataset.totalHands) - parseFloat(b.dataset.totalHands);
                        } else if (sortValue === 'bb-desc') {
                            return parseFloat(b.dataset.totalBb) - parseFloat(a.dataset.totalBb);
                        } else if (sortValue === 'bb-asc') {
                            return parseFloat(a.dataset.totalBb) - parseFloat(b.dataset.totalBb);
                        } else if (sortValue === 'avg-desc') {
                            return parseFloat(b.dataset.avgBb) - parseFloat(a.dataset.avgBb);
                        } else if (sortValue === 'avg-asc') {
                            return parseFloat(a.dataset.avgBb) - parseFloat(b.dataset.avgBb);
                        }
                        return 0;
                    });
                    
                    rows.forEach(row => tbody.appendChild(row));
                }
                
                sortSelect.addEventListener('change', sortTable);
            })();
            </script>
        {% else %}
            <p class="text-muted">No flop high card data available. Please reprocess this post.</p>
        {% endif %}
    </div>
</div>

{% set flop_scenarios = [
    {
        'id': 'oop',
        'title': 'OOP Action',
        'hero': metrics.get('flop_Hero_op_action', {}),
        'villain': metrics.get('flop_Villain_op_action', {}),
        'actions': [
            {'label': 'Checks', 'hero_key': 'Check', 'villain_key': 'Villain_checks'},
            {'label': 'Bets', 'hero_key': 'Bets', 'villain_key': 'Villain_bets'}
        ]
    },
    {
        'id': 'ip',
        'title': 'IP Action',
        'hero': metrics.get('flop_Hero_ip_action', {}),
        'villain': metrics.get('flop_Villain_ip_action', {}),
        'actions': [
            {'label': 'Checks', 'hero_key': 'checks', 'villain_key': 'Villain_checks'},
            {'label': 'Bets', 'hero_key': 'ip_cbets', 'villain_key': 'Villain_cbets'}
        ]
    },
    {
        'id': 'oop_vs_cbet',
        'title': 'OOP Facing C-Bet',
        'hero': metrics.get('flop_Hero_op_vs_cbet', {}),
        'villain': metrics.get('flop_Villain_op_vs_cbet', {}),
        'actions': [
            {'label': 'Calls', 'hero_key': 'Call_cbet', 'villain_key': 'Call_cbet'},
            {'label': 'Raises', 'hero_key': 'Raise_cbet', 'villain_key': 'Raise_cbet'},
            {'label': 'Folds', 'hero_key': 'Fold_to_cbet', 'villain_key': 'Fold_to_cbet'}
        ]
    },
    {
        'id': 'ip_vs_donk',
        'title': 'IP Facing Donk',
        'hero': metrics.get('flop_Hero_ip_vs_donk', {}),
        'villain': metrics.get('flop_Villain_ip_vs_donk', {}),
        'actions': [
            {'label': 'Calls', 'hero_key': 'Hero_Calls', 'villain_key': 'Villain_Calls'},
            {'label': 'Raises', 'hero_key': 'Hero_Raises', 'villain_key': 'Villain_Raises'},
            {'label': 'Folds', 'hero_key': 'Hero_Folds', 'villain_key': 'Villain_Folds'}
        ]
    },
    {
        'id': 'ip_vs_checkraise',
        'title': 'IP Facing Check-Raise',
        'hero': metrics.get('flop_Hero_ip_vs_checkraise', {}),
        'villain': metrics.get('flop_Villain_ip_vs_checkraise', {}),
        'actions': [
            {'label': 'Calls', 'hero_key': 'Hero_Calls', 'villain_key': 'Villain_Calls'},
            {'label': 'Raises', 'hero_key': 'Hero_Raises', 'villain_key': 'Villain_Raises'},
            {'label': 'Folds', 'hero_key': 'Hero_Folds', 'villain_key': 'Villain_Folds'}
        ]
    }
] %}

<div class="card mb-4">
    <div class="card-header">
        <h3 class="mb-0">Flop Action Comparison</h3>
        <p class="text-muted mb-0">Hero vs Villain action frequencies by scenario</p>
    </div>
    <div class="card-body">
        <div class="row g-3">
            {% for scenario in flop_scenarios %}
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong>{{ scenario.title }}</strong>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Totals</span>
                            <span>
                                Hero {{ scenario.hero.get('total', 0) }}
                                <span class="text-muted">/</span>
                                Villain {{ scenario.villain.get('total', 0) }}
                            </span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Action</th>
                                        <th>Hero %</th>
                                        <th>Villain %</th>
                                        <th>Diff</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for action in scenario.actions %}
                                    {% set hero_val = scenario.hero.get(action.hero_key, 0) %}
                                    {% set villain_val = scenario.villain.get(action.villain_key, 0) %}
                                    {% set diff = hero_val - villain_val %}
                                    <tr>
                                        <td>{{ action.label }}</td>
                                        <td>{{ "%.2f"|format(hero_val) }}%</td>
                                        <td>{{ "%.2f"|format(villain_val) }}%</td>
                                        <td>
                                            {% if diff >= 0 %}+{% endif %}{{ "%.2f"|format(diff) }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h3 class="mb-0">Detailed Flop Action Breakdown</h3>
        <p class="text-muted mb-0">Percentages with totals and Hero vs Villain differences</p>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Scenario</th>
                        <th>Action</th>
                        <th>Hero %</th>
                        <th>Villain %</th>
                        <th>Diff</th>
                        <th>Hero Total</th>
                        <th>Villain Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scenario in flop_scenarios %}
                        {% for action in scenario.actions %}
                        {% set hero_val = scenario.hero.get(action.hero_key, 0) %}
                        {% set villain_val = scenario.villain.get(action.villain_key, 0) %}
                        {% set diff = hero_val - villain_val %}
                        <tr>
                            <td><strong>{{ scenario.title }}</strong></td>
                            <td>{{ action.label }}</td>
                            <td>{{ "%.2f"|format(hero_val) }}%</td>
                            <td>{{ "%.2f"|format(villain_val) }}%</td>
                            <td>
                                {% if diff >= 0 %}+{% endif %}{{ "%.2f"|format(diff) }}%
                            </td>
                            <td>{{ scenario.hero.get('total', 0) }}</td>
                            <td>{{ scenario.villain.get('total', 0) }}</td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Flop Bet Sizing Analysis -->
<div class="card mb-4 mt-4">
    <div class="card-header">
        <h3>Flop Bet Sizing Analysis</h3>
        <p class="text-muted mb-0">Opponent responses to your bets by bet size (% of pot)</p>
    </div>
    <div class="card-body">
        {% if metrics.get('Flop Bet Sizing Analysis') %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Bet Size</th>
                            <th>Total Bets</th>
                            <th>Folds</th>
                            <th>Fold %</th>
                            <th>Calls</th>
                            <th>Call %</th>
                            <th>Raises</th>
                            <th>Raise %</th>
                            <th>Total BB Earnings</th>
                            <th>Avg BB/Bet</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category, data in metrics.get('Flop Bet Sizing Analysis', {}).items() %}
                        <tr>
                            <td><strong>{{ category }}</strong></td>
                            <td>{{ data.get('total_bets', 0) }}</td>
                            <td>{{ data.get('folds', 0) }}</td>
                            <td>{{ data.get('fold_pct', 0) }}%</td>
                            <td>{{ data.get('calls', 0) }}</td>
                            <td>{{ data.get('call_pct', 0) }}%</td>
                            <td>{{ data.get('raises', 0) }}</td>
                            <td>{{ data.get('raise_pct', 0) }}%</td>
                            <td class="{% if data.get('total_bb_earnings', 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(data.get('total_bb_earnings', 0)) }} BB
                            </td>
                            <td class="{% if data.get('avg_bb_per_bet', 0) >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(data.get('avg_bb_per_bet', 0)) }} BB
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-muted">No flop bet sizing data available. Please reprocess this post.</p>
        {% endif %}
    </div>
</div>
</br>
</br>
</br>
{% endblock %}