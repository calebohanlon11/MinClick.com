{% block metrics %}
<!-- Definitions -->
<div class="alert alert-primary mb-4">
    <h5 class="mb-3"><strong>Key Definitions:</strong></h5>
    <ul class="mb-0">
        <li><strong>Viable Hands / Total Hands:</strong> Total number of hands in the dataset (all hands dealt to Hero)</li>
        <li><strong>VPIP (Voluntarily Put In Pot):</strong> Number of hands where Hero put chips in from any position (includes RFI, call, limp, 3-bet, 4-bet, etc.)</li>
        <li><strong>RFI VPIP (Raise First In):</strong> Number of hands where Hero was the FIRST person to open raise into the pot (RFI only, not limp or call)</li>
    </ul>
</div>

{% if metrics.get('Comprehensive Preflop Metrics') %}
{% set comp_metrics = metrics['Comprehensive Preflop Metrics'] %}

<!-- Section 1: Total Hands (All hands dealt, including folds) -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">1. Total Hands Dealt</h2>
        <p class="mb-0"><small>All hands you were dealt, including folds preflop</small></p>
    </div>
    <div class="card-body">
        <h4 class="text-center mb-3">Total: <strong>{{ comp_metrics.get('total_hands', {}).get('total', 0) }}</strong> hands</h4>
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>UTG</th>
                    <th>MP</th>
                    <th>CO</th>
                    <th>BTN</th>
                    <th>SB</th>
                    <th>BB</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ comp_metrics.get('total_hands', {}).get('by_position', {}).get('UTG', 0) }}</td>
                    <td>{{ comp_metrics.get('total_hands', {}).get('by_position', {}).get('MP', 0) }}</td>
                    <td>{{ comp_metrics.get('total_hands', {}).get('by_position', {}).get('CO', 0) }}</td>
                    <td>{{ comp_metrics.get('total_hands', {}).get('by_position', {}).get('BTN', 0) }}</td>
                    <td>{{ comp_metrics.get('total_hands', {}).get('by_position', {}).get('SB', 0) }}</td>
                    <td>{{ comp_metrics.get('total_hands', {}).get('by_position', {}).get('BB', 0) }}</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Section 2: RFI Hands (Raise First In) -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h2 class="mb-0">2. RFI Hands (Raise First In)</h2>
        <p class="mb-0"><small>Hands where you raised first in or limped (opened the pot)</small></p>
    </div>
    <div class="card-body">
        <h4 class="text-center mb-3">Total: <strong>{{ comp_metrics.get('rfi_hands', {}).get('total', 0) }}</strong> hands ({{ "%.1f"|format((comp_metrics.get('rfi_hands', {}).get('total', 0) / comp_metrics.get('total_hands', {}).get('total', 1) * 100) if comp_metrics.get('total_hands', {}).get('total', 0) > 0 else 0) }}% of total)</h4>
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>UTG</th>
                    <th>MP</th>
                    <th>CO</th>
                    <th>BTN</th>
                    <th>SB</th>
                    <th>BB</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {{ comp_metrics.get('rfi_hands', {}).get('by_position', {}).get('UTG', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('rfi_hands', {}).get('percent_by_position', {}).get('UTG', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('rfi_hands', {}).get('by_position', {}).get('MP', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('rfi_hands', {}).get('percent_by_position', {}).get('MP', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('rfi_hands', {}).get('by_position', {}).get('CO', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('rfi_hands', {}).get('percent_by_position', {}).get('CO', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('rfi_hands', {}).get('by_position', {}).get('BTN', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('rfi_hands', {}).get('percent_by_position', {}).get('BTN', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('rfi_hands', {}).get('by_position', {}).get('SB', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('rfi_hands', {}).get('percent_by_position', {}).get('SB', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('rfi_hands', {}).get('by_position', {}).get('BB', 0) }}<br/>
                        <small class="text-muted">(N/A - BB can't RFI)</small>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Section 3: VPIP Hands (All hands where chips were put in) -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h2 class="mb-0">3. VPIP Hands (Voluntarily Put In Pot)</h2>
        <p class="mb-0"><small>All hands where you put chips in: RFI, call, limp, 3-bet, 4-bet, etc.</small></p>
    </div>
    <div class="card-body">
        <h4 class="text-center mb-3">Total: <strong>{{ comp_metrics.get('vpip_hands', {}).get('total', 0) }}</strong> hands ({{ "%.1f"|format((comp_metrics.get('vpip_hands', {}).get('total', 0) / comp_metrics.get('total_hands', {}).get('total', 1) * 100) if comp_metrics.get('total_hands', {}).get('total', 0) > 0 else 0) }}% of total)</h4>
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>UTG</th>
                    <th>MP</th>
                    <th>CO</th>
                    <th>BTN</th>
                    <th>SB</th>
                    <th>BB</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {{ comp_metrics.get('vpip_hands', {}).get('by_position', {}).get('UTG', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('vpip_hands', {}).get('percent_by_position', {}).get('UTG', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('vpip_hands', {}).get('by_position', {}).get('MP', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('vpip_hands', {}).get('percent_by_position', {}).get('MP', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('vpip_hands', {}).get('by_position', {}).get('CO', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('vpip_hands', {}).get('percent_by_position', {}).get('CO', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('vpip_hands', {}).get('by_position', {}).get('BTN', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('vpip_hands', {}).get('percent_by_position', {}).get('BTN', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('vpip_hands', {}).get('by_position', {}).get('SB', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('vpip_hands', {}).get('percent_by_position', {}).get('SB', 0) }}%)</small>
                    </td>
                    <td>
                        {{ comp_metrics.get('vpip_hands', {}).get('by_position', {}).get('BB', 0) }}<br/>
                        <small class="text-muted">({{ comp_metrics.get('vpip_hands', {}).get('percent_by_position', {}).get('BB', 0) }}%)</small>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% else %}
<!-- Fallback to old format if comprehensive metrics not available -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h2 class="mb-0">VPIP Summary</h2>
    </div>
    <div class="card-body">
        {% set total_hands = metrics.get('Total Hands', metrics.get('VPIP Info', {}).get('num_viable_hands', 0)) %}
        {% set vpip_count = metrics.get('VPIP Info', {}).get('vpip_count', 0) %}
        {% set vpip_percent = metrics.get('VPIP Info', {}).get('general_vpip', 0) %}
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Hands in Dataset</h5>
                        <h3 class="mb-0">{{ total_hands }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">VPIP Hands</h5>
                        <h3 class="mb-0">{{ vpip_count }}</h3>
                        <p class="text-muted mb-0">{{ vpip_percent }}% VPIP</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <strong>VPIP Rate:</strong> {{ vpip_count }} out of {{ total_hands }} hands = <strong>{{ "%.1f"|format((vpip_count / total_hands * 100) if total_hands > 0 else 0) }}%</strong>
            <br><small><strong>VPIP</strong> = Voluntarily Put In Pot (all hands where you put chips in: RFI, call, limp, 3-bet, 4-bet, etc.)</small>
        </div>
    </div>
</div>

<h2>VPIP by Position ({{ metrics.get('VPIP Info', {}).get('num_viable_hands', 0) }} Total Hands)</h2>
{% set vpip_info = metrics.get('VPIP Info', {}) %}
{% set positional_vpip = vpip_info.get('positional_vpip', {}) %}
{% set positional_hand_counts = vpip_info.get('positional_hand_counts', {}) %}

<!-- DEBUG: Show what we're receiving -->
<div class="alert alert-warning">
    <strong>DEBUG INFO (Template Values):</strong><br>
    positional_hand_counts exists: {{ positional_hand_counts is defined }}<br>
    positional_hand_counts value: {{ positional_hand_counts }}<br>
    UTG: {{ positional_hand_counts.get('UTG', 'NOT_FOUND') }}<br>
    MP: {{ positional_hand_counts.get('MP', 'NOT_FOUND') }}<br>
    CO: {{ positional_hand_counts.get('CO', 'NOT_FOUND') }}<br>
    BTN: {{ positional_hand_counts.get('BTN', 'NOT_FOUND') }}<br>
    SB: {{ positional_hand_counts.get('SB', 'NOT_FOUND') }}<br>
    BB: {{ positional_hand_counts.get('BB', 'NOT_FOUND') }}<br>
    <small>If all values show 0 or NOT_FOUND, the data isn't being passed correctly from views.py</small>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>UTG</th>
            <th>MP</th>
            <th>CO</th>
            <th>BTN</th>
            <th>SB</th>
            <th>BB</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ positional_vpip.get('UTG', 0) }}%</td>
            <td>{{ positional_vpip.get('MP', 0) }}%</td>
            <td>{{ positional_vpip.get('CO', 0) }}%</td>
            <td>{{ positional_vpip.get('BTN', 0) }}%</td>
            <td>{{ positional_vpip.get('SB', 0) }}%</td>
            <td>{{ positional_vpip.get('BB', 0) }}%</td>
        </tr>
        <tr class="table-secondary">
            <td><strong>{{ positional_hand_counts.get('UTG', 0) }} hands</strong></td>
            <td><strong>{{ positional_hand_counts.get('MP', 0) }} hands</strong></td>
            <td><strong>{{ positional_hand_counts.get('CO', 0) }} hands</strong></td>
            <td><strong>{{ positional_hand_counts.get('BTN', 0) }} hands</strong></td>
            <td><strong>{{ positional_hand_counts.get('SB', 0) }} hands</strong></td>
            <td><strong>{{ positional_hand_counts.get('BB', 0) }} hands</strong></td>
        </tr>
    </tbody>
</table>

<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h2 class="mb-0">RFI VPIP Summary</h2>
        <p class="mb-0"><small>RFI = Raise First In (first person to open raise into the pot)</small></p>
    </div>
    <div class="card-body">
        {% set rfi_viable_hands = metrics.get('RFI VPIP Info', {}).get('num_viable_hands', 0) %}
        {% set rfi_count = metrics.get('RFI VPIP Info', {}).get('rfi_count', 0) %}
        {% set rfi_percent = metrics.get('RFI VPIP Info', {}).get('general_rfi_vpip', 0) %}
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total Non-BB Hands</h5>
                        <p class="text-muted mb-1"><small>(BB can't RFI since they're already in the pot)</small></p>
                        <h3 class="mb-0">{{ rfi_viable_hands }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">RFI Hands</h5>
                        <h3 class="mb-0">{{ rfi_count }}</h3>
                        <p class="text-muted mb-0">{{ rfi_percent }}% RFI VPIP</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-success">
            <strong>RFI VPIP Rate:</strong> {{ rfi_count }} out of {{ rfi_viable_hands }} non-BB hands = <strong>{{ "%.1f"|format((rfi_count / rfi_viable_hands * 100) if rfi_viable_hands > 0 else 0) }}%</strong>
        </div>
    </div>
</div>

<h2>RFI VPIP by Position ({{ metrics.get('RFI VPIP Info', {}).get('num_viable_hands', 0) }} Non-BB Hands)</h2>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>UTG</th>
            <th>MP</th>
            <th>CO</th>
            <th>BTN</th>
            <th>SB</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('UTG', 0) }}</td>
            <td>{{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('MP', 0) }}</td>
            <td>{{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('CO', 0) }}</td>
            <td>{{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('BTN', 0) }}</td>
            <td>{{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('SB', 0) }}</td>
        </tr>
    </tbody>
</table>
{% endif %}
<br/>
<br/>

<!-- Section 4: Three Bet Metrics -->
{% set three_bet = metrics.get('Three bet info', {}) %}
{% set three_bet_std = three_bet.get('standardized', {}) %}
{% set total_3bets = three_bet_std.get('hero_3bet_count', three_bet.get('Num_three_bets', 0)) %}
{% set viable_hands = three_bet.get('Viable_hands', 1) %}
{% set total_bb = three_bet.get('Sum_results_BB', 0) %}
{% set avg_bb = three_bet.get('Avg_result_BB', 0) %}
{% set three_bet_opps = three_bet_std.get('facing_open_opportunities', 0) %}
{% set three_bet_opp_rate = (total_3bets / three_bet_opps * 100) if three_bet_opps > 0 else None %}
{% set villain_response_3b = three_bet_std.get('villain_response', {}) %}
{% set villain_fold = villain_response_3b.get('fold', 0) %}
{% set villain_call = villain_response_3b.get('call', 0) %}
{% set villain_4bet = villain_response_3b.get('raise', 0) %}
{% set hero_positions = ['UTG', 'MP', 'CO', 'BTN', 'SB', 'BB'] %}
{% set by_hero_position = three_bet.get('by_hero_position', {}) %}
{% set by_opener_position = three_bet.get('by_opener_position', {}) %}
{% set branch_ev = three_bet_std.get('branch_ev', {}) %}
{% set hero_vs_raise_3b = three_bet_std.get('hero_vs_raise', {}) %}

<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h2 class="mb-0">4. Three Bet Metrics</h2>
        <p class="mb-0"><small>Aggressive re-raising statistics and profitability</small></p>
    </div>
    <div class="card-body">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total 3-Bets</h5>
                        <h3 class="text-primary">{{ total_3bets }}</h3>
                        <small class="text-muted">3-Bet % (of opps):
                            {% if three_bet_opp_rate is not none %}
                                {{ "%.1f"|format(three_bet_opp_rate) }}%
                            {% else %}
                                —
                            {% endif %}
                        </small><br/>
                        <small class="text-muted">Opportunities: {{ three_bet_opps }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Fold to 3-Bet %</h5>
                        <h3 class="text-info">
                            {% if total_3bets > 0 %}
                                {{ "%.1f"|format((villain_fold / total_3bets) * 100) }}%
                            {% else %}
                                —
                            {% endif %}
                        </h3>
                        <small class="text-muted">{{ villain_fold }} folds</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Call vs 3-Bet %</h5>
                        <h3 class="text-primary">
                            {% if total_3bets > 0 %}
                                {{ "%.1f"|format((villain_call / total_3bets) * 100) }}%
                            {% else %}
                                —
                            {% endif %}
                        </h3>
                        <small class="text-muted">{{ villain_call }} calls</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-muted">4-Bet vs 3-Bet %</h5>
                        <h3 class="text-warning">
                            {% if total_3bets > 0 %}
                                {{ "%.1f"|format((villain_4bet / total_3bets) * 100) }}%
                            {% else %}
                                —
                            {% endif %}
                        </h3>
                        <small class="text-muted">{{ villain_4bet }} 4-bets</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Three Bet Counts by Position -->
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
                <h4 class="mb-0">Three Bet Frequency by Position</h4>
                <small class="text-muted d-block">Hero position = your seat; Opener position = player who opened before your 3-bet.</small>
            </div>
            <div class="btn-group" role="group" aria-label="3-bet view toggle">
                <button type="button" class="btn btn-sm btn-outline-primary active" id="threeBetViewHero">By Hero Position</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="threeBetViewOpener">By Opener Position</button>
            </div>
        </div>
        <table class="table table-bordered table-hover mb-4" id="threeBetTableHero">
            <thead class="table-dark">
                <tr>
                    <th>Position</th>
                    <th>Opportunities</th>
                    <th>3-Bets</th>
                    <th>3-Bet %</th>
                    <th>Villain Fold % (to 3-bet)</th>
                    <th>Villain Call % (to 3-bet)</th>
                    <th>Villain 4-Bet % (vs 3-bet)</th>
                    <th>Total BB</th>
                    <th>EV / Opportunity</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in hero_positions %}
                {% set pos_data = by_hero_position.get(pos, {}) %}
                {% set pos_opps = pos_data.get('opportunities', 0) %}
                {% set pos_3bets = pos_data.get('three_bets', 0) %}
                {% set pos_fold = pos_data.get('villain_fold', 0) %}
                {% set pos_call = pos_data.get('villain_call', 0) %}
                {% set pos_4bet = pos_data.get('villain_4bet', 0) %}
                {% set pos_ev = pos_data.get('ev_bb', 0) %}
                {% set pos_3bet_rate = (pos_3bets / pos_opps * 100) if pos_opps > 0 else None %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td>{{ pos_opps|int }}</td>
                    <td>{{ pos_3bets|int }}</td>
                    <td>{% if pos_3bet_rate is not none %}{{ "%.1f"|format(pos_3bet_rate) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_3bets > 0 %}{{ "%.1f"|format((pos_fold / pos_3bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_3bets > 0 %}{{ "%.1f"|format((pos_call / pos_3bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_3bets > 0 %}{{ "%.1f"|format((pos_4bet / pos_3bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td class="{% if pos_ev >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_ev) }} BB</strong>
                    </td>
                    <td>{% if pos_opps > 0 %}{{ "%.2f"|format(pos_ev / pos_opps) }} BB{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="table table-bordered table-hover mb-4 d-none" id="threeBetTableOpener">
            <thead class="table-dark">
                <tr>
                    <th>Opener Position</th>
                    <th>Opportunities</th>
                    <th>3-Bets</th>
                    <th>3-Bet %</th>
                    <th>Villain Fold % (to 3-bet)</th>
                    <th>Villain Call % (to 3-bet)</th>
                    <th>Villain 4-Bet % (vs 3-bet)</th>
                    <th>Total BB</th>
                    <th>EV / Opportunity</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in hero_positions %}
                {% set pos_data = by_opener_position.get(pos, {}) %}
                {% set pos_opps = pos_data.get('opportunities', 0) %}
                {% set pos_3bets = pos_data.get('three_bets', 0) %}
                {% set pos_fold = pos_data.get('villain_fold', 0) %}
                {% set pos_call = pos_data.get('villain_call', 0) %}
                {% set pos_4bet = pos_data.get('villain_4bet', 0) %}
                {% set pos_ev = pos_data.get('ev_bb', 0) %}
                {% set pos_3bet_rate = (pos_3bets / pos_opps * 100) if pos_opps > 0 else None %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td>{{ pos_opps|int }}</td>
                    <td>{{ pos_3bets|int }}</td>
                    <td>{% if pos_3bet_rate is not none %}{{ "%.1f"|format(pos_3bet_rate) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_3bets > 0 %}{{ "%.1f"|format((pos_fold / pos_3bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_3bets > 0 %}{{ "%.1f"|format((pos_call / pos_3bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_3bets > 0 %}{{ "%.1f"|format((pos_4bet / pos_3bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td class="{% if pos_ev >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_ev) }} BB</strong>
                    </td>
                    <td>{% if pos_opps > 0 %}{{ "%.2f"|format(pos_ev / pos_opps) }} BB{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Profitability Breakdown: Preflop vs Postflop -->
        {% set positions_with_utg = ['UTG', 'MP', 'CO', 'BTN', 'SB', 'BB'] %}
        <h4 class="mb-3">Profitability Breakdown: Preflop vs Postflop</h4>
        {% set positions_with_utg = ['UTG', 'MP', 'CO', 'BTN', 'SB', 'BB'] %}
        <table class="table table-bordered table-hover mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Position</th>
                    <th>Preflop BB</th>
                    <th>Postflop BB</th>
                    <th>Total BB</th>
                    <th>% Preflop</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in positions_with_utg %}
                {% set pos_no_flop = three_bet.get('Sum_results_position_no_flop_BB', {}).get(pos, 0) %}
                {% set pos_flop = three_bet.get('Sum_results_position_flop_BB', {}).get(pos, 0) %}
                {% set pos_total = pos_no_flop + pos_flop %}
                {% set preflop_pct = (pos_no_flop / pos_total * 100) if pos_total != 0 else 0 %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td class="{% if pos_no_flop >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_no_flop) }} BB
                    </td>
                    <td class="{% if pos_flop >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_flop) }} BB
                    </td>
                    <td class="{% if pos_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_total) }} BB</strong>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar {% if preflop_pct >= 50 %}bg-success{% else %}bg-info{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ preflop_pct|abs }}%"
                                 aria-valuenow="{{ preflop_pct|abs }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ "%.1f"|format(preflop_pct) }}%
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h4 class="mb-3">EV by Branch (After You 3-Bet)</h4>
        <table class="table table-bordered table-hover mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Branch</th>
                    <th>Hands</th>
                    <th>Total EV (BB)</th>
                    <th>EV / Hand (BB)</th>
                </tr>
            </thead>
            <tbody>
                {% set fold_branch = branch_ev.get('fold', {}) %}
                {% set call_branch = branch_ev.get('call', {}) %}
                {% set four_bet_branch = branch_ev.get('raise', {}) %}
                <tr>
                    <td>Villain Folds</td>
                    <td>{{ fold_branch.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(fold_branch.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if fold_branch.get('count', 0) > 0 %}
                            {{ "%.2f"|format(fold_branch.get('ev_bb', 0) / fold_branch.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Villain Calls</td>
                    <td>{{ call_branch.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(call_branch.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if call_branch.get('count', 0) > 0 %}
                            {{ "%.2f"|format(call_branch.get('ev_bb', 0) / call_branch.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Villain 4-Bets</td>
                    <td>{{ four_bet_branch.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(four_bet_branch.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if four_bet_branch.get('count', 0) > 0 %}
                            {{ "%.2f"|format(four_bet_branch.get('ev_bb', 0) / four_bet_branch.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% set four_bet_fold = hero_vs_raise_3b.get('fold', {}) %}
                {% set four_bet_call = hero_vs_raise_3b.get('call', {}) %}
                {% set four_bet_5bet = hero_vs_raise_3b.get('jam', {}) %}
                {% if four_bet_fold.get('count', 0) or four_bet_call.get('count', 0) or four_bet_5bet.get('count', 0) %}
                <tr>
                    <td>Hero Folds vs 4-Bet</td>
                    <td>{{ four_bet_fold.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(four_bet_fold.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if four_bet_fold.get('count', 0) > 0 %}
                            {{ "%.2f"|format(four_bet_fold.get('ev_bb', 0) / four_bet_fold.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Hero Calls vs 4-Bet</td>
                    <td>{{ four_bet_call.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(four_bet_call.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if four_bet_call.get('count', 0) > 0 %}
                            {{ "%.2f"|format(four_bet_call.get('ev_bb', 0) / four_bet_call.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Hero 5-Bets vs 4-Bet</td>
                    <td>{{ four_bet_5bet.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(four_bet_5bet.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if four_bet_5bet.get('count', 0) > 0 %}
                            {{ "%.2f"|format(four_bet_5bet.get('ev_bb', 0) / four_bet_5bet.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Key Insights -->
        <div class="alert alert-info">
            <h5><i class="fas fa-lightbulb"></i> Key Insights:</h5>
            <ul class="mb-0">
                <li><strong>Total 3-Bets:</strong> {{ total_3bets }} ({{ "%.1f"|format(three_bet_opp_rate) if three_bet_opp_rate is not none else "—" }}% of {{ three_bet_opps }} opportunities)</li>
                <li><strong>Villain Response Split:</strong>
                    {% if total_3bets > 0 %}
                        Fold {{ "%.1f"|format((villain_fold / total_3bets) * 100) }}% /
                        Call {{ "%.1f"|format((villain_call / total_3bets) * 100) }}% /
                        4-Bet {{ "%.1f"|format((villain_4bet / total_3bets) * 100) }}%
                    {% else %}
                        —
                    {% endif %}
                </li>
                <li><strong>Biggest Losing Branch:</strong>
                    {% set fold_ev = branch_ev.get('fold', {}).get('ev_bb', 0) %}
                    {% set call_ev = branch_ev.get('call', {}).get('ev_bb', 0) %}
                    {% set four_ev = branch_ev.get('raise', {}).get('ev_bb', 0) %}
                    {% if fold_ev <= call_ev and fold_ev <= four_ev %}Villain Folds{% elif call_ev <= four_ev %}Villain Calls{% else %}Villain 4-Bets{% endif %}
                </li>
                {% if total_3bets < 30 %}
                <li class="text-warning"><strong>Sample size warning:</strong> Fewer than 30 total 3-bets may make percentages noisy.</li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<!-- Section 5: Four Bet Metrics -->
{% set four_bet = metrics.get('Four bet info', {}) %}
{% set four_bet_std = four_bet.get('standardized', {}) %}
{% set total_4bets = four_bet_std.get('hero_4bet_count', four_bet.get('Num_four_bets', 0)) %}
{% set viable_hands_4b = four_bet.get('Viable_hands', 1) %}
{% set total_bb_4b = four_bet.get('Sum_results_BB', 0) %}
{% set avg_bb_4b = four_bet.get('Avg_result_BB', 0) %}
{% set preflop_wins_4b = four_bet.get('Num_four_bet_wins', 0) %}
{% set win_rate_4b = (preflop_wins_4b / total_4bets * 100) if total_4bets > 0 else 0 %}
{% set four_bet_opps = four_bet_std.get('facing_3bet_opportunities', 0) %}
{% set four_bet_opp_rate = (total_4bets / four_bet_opps * 100) if four_bet_opps > 0 else None %}
{% set villain_response_4b = four_bet_std.get('villain_response', {}) %}
{% set villain_fold_4b = villain_response_4b.get('fold', 0) %}
{% set villain_call_4b = villain_response_4b.get('call', 0) %}
{% set villain_5bet_4b = villain_response_4b.get('raise', 0) %}
{% set villain_5bet_jam_4b = four_bet_std.get('villain_raise_subtype', {}).get('jam', 0) %}
{% set hero_positions_4b = ['UTG', 'MP', 'CO', 'BTN', 'SB', 'BB'] %}
{% set by_hero_position_4b = four_bet.get('by_hero_position', {}) %}
{% set by_three_bettor_position = four_bet.get('by_three_bettor_position', {}) %}
{% set branch_ev_4b = four_bet_std.get('branch_ev', {}) %}
{% set hero_vs_raise_4b = four_bet_std.get('hero_vs_raise', {}) %}

<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h2 class="mb-0">5. Four Bet Metrics</h2>
        <p class="mb-0"><small>Preflop 4-bet aggression and profitability</small></p>
    </div>
    <div class="card-body">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total 4-Bets</h5>
                        <h3 class="text-primary">{{ total_4bets }}</h3>
                        <small class="text-muted">4-Bet % (of opps):
                            {% if four_bet_opp_rate is not none %}
                                {{ "%.1f"|format(four_bet_opp_rate) }}%
                            {% else %}
                                —
                            {% endif %}
                        </small><br/>
                        <small class="text-muted">Opportunities: {{ four_bet_opps }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-info">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Fold to 4-Bet %</h5>
                        <h3 class="text-info">
                            {% if total_4bets > 0 %}
                                {{ "%.1f"|format((villain_fold_4b / total_4bets) * 100) }}%
                            {% else %}
                                —
                            {% endif %}
                        </h3>
                        <small class="text-muted">{{ villain_fold_4b }} folds</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Call vs 4-Bet %</h5>
                        <h3 class="text-primary">
                            {% if total_4bets > 0 %}
                                {{ "%.1f"|format((villain_call_4b / total_4bets) * 100) }}%
                            {% else %}
                                —
                            {% endif %}
                        </h3>
                        <small class="text-muted">{{ villain_call_4b }} calls</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-warning">
                    <div class="card-body">
                        <h5 class="card-title text-muted">5-Bet vs 4-Bet %</h5>
                        <h3 class="text-warning">
                            {% if total_4bets > 0 %}
                                {{ "%.1f"|format((villain_5bet_4b / total_4bets) * 100) }}%
                            {% else %}
                                —
                            {% endif %}
                        </h3>
                        <small class="text-muted">{{ villain_5bet_4b }} 5-bets</small>
                        {% if villain_5bet_4b > 0 %}
                        <small class="text-muted d-block">5-bet jam %: {{ "%.1f"|format((villain_5bet_jam_4b / villain_5bet_4b) * 100) }}%</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Four Bet Counts by Position -->
        <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
                <h4 class="mb-0">Four Bet Frequency by Position</h4>
                <small class="text-muted d-block">Hero position = your seat; 3-bettor position = player who 3-bet before your 4-bet.</small>
            </div>
            <div class="btn-group" role="group" aria-label="4-bet view toggle">
                <button type="button" class="btn btn-sm btn-outline-primary active" id="fourBetViewHero">By Hero Position</button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="fourBetViewThreeBettor">By 3-Bettor Position</button>
            </div>
        </div>
        <table class="table table-bordered table-hover mb-4" id="fourBetTableHero">
            <thead class="table-dark">
                <tr>
                    <th>Position</th>
                    <th>Opportunities</th>
                    <th>4-Bets</th>
                    <th>4-Bet %</th>
                    <th>Villain Fold % (to 4-bet)</th>
                    <th>Villain Call % (to 4-bet)</th>
                    <th>Villain 5-Bet % (vs 4-bet)</th>
                    <th>Total BB</th>
                    <th>EV / Opportunity</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in hero_positions_4b %}
                {% set pos_data = by_hero_position_4b.get(pos, {}) %}
                {% set pos_opps = pos_data.get('opportunities', 0) %}
                {% set pos_4bets = pos_data.get('four_bets', 0) %}
                {% set pos_fold = pos_data.get('villain_fold', 0) %}
                {% set pos_call = pos_data.get('villain_call', 0) %}
                {% set pos_5bet = pos_data.get('villain_5bet', 0) %}
                {% set pos_ev = pos_data.get('ev_bb', 0) %}
                {% set pos_4bet_rate = (pos_4bets / pos_opps * 100) if pos_opps > 0 else None %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td>{{ pos_opps|int }}</td>
                    <td>{{ pos_4bets|int }}</td>
                    <td>{% if pos_4bet_rate is not none %}{{ "%.1f"|format(pos_4bet_rate) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_4bets > 0 %}{{ "%.1f"|format((pos_fold / pos_4bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_4bets > 0 %}{{ "%.1f"|format((pos_call / pos_4bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_4bets > 0 %}{{ "%.1f"|format((pos_5bet / pos_4bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td class="{% if pos_ev >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_ev) }} BB</strong>
                    </td>
                    <td>{% if pos_opps > 0 %}{{ "%.2f"|format(pos_ev / pos_opps) }} BB{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="table table-bordered table-hover mb-4 d-none" id="fourBetTableThreeBettor">
            <thead class="table-dark">
                <tr>
                    <th>3-Bettor Position</th>
                    <th>Opportunities</th>
                    <th>4-Bets</th>
                    <th>4-Bet %</th>
                    <th>Villain Fold % (to 4-bet)</th>
                    <th>Villain Call % (to 4-bet)</th>
                    <th>Villain 5-Bet % (vs 4-bet)</th>
                    <th>Total BB</th>
                    <th>EV / Opportunity</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in hero_positions_4b %}
                {% set pos_data = by_three_bettor_position.get(pos, {}) %}
                {% set pos_opps = pos_data.get('opportunities', 0) %}
                {% set pos_4bets = pos_data.get('four_bets', 0) %}
                {% set pos_fold = pos_data.get('villain_fold', 0) %}
                {% set pos_call = pos_data.get('villain_call', 0) %}
                {% set pos_5bet = pos_data.get('villain_5bet', 0) %}
                {% set pos_ev = pos_data.get('ev_bb', 0) %}
                {% set pos_4bet_rate = (pos_4bets / pos_opps * 100) if pos_opps > 0 else None %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td>{{ pos_opps|int }}</td>
                    <td>{{ pos_4bets|int }}</td>
                    <td>{% if pos_4bet_rate is not none %}{{ "%.1f"|format(pos_4bet_rate) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_4bets > 0 %}{{ "%.1f"|format((pos_fold / pos_4bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_4bets > 0 %}{{ "%.1f"|format((pos_call / pos_4bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td>{% if pos_4bets > 0 %}{{ "%.1f"|format((pos_5bet / pos_4bets) * 100) }}%{% else %}—{% endif %}</td>
                    <td class="{% if pos_ev >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_ev) }} BB</strong>
                    </td>
                    <td>{% if pos_opps > 0 %}{{ "%.2f"|format(pos_ev / pos_opps) }} BB{% else %}—{% endif %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Profitability Breakdown: Preflop vs Postflop -->
        <h4 class="mb-3">Profitability Breakdown: Preflop vs Postflop</h4>
        <table class="table table-bordered table-hover mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Position</th>
                    <th>Preflop BB</th>
                    <th>Postflop BB</th>
                    <th>Total BB</th>
                    <th>% Preflop</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in positions_with_utg %}
                {% set pos_no_flop = four_bet.get('Sum_results_position_no_flop_BB', {}).get(pos, 0) %}
                {% set pos_flop = four_bet.get('Sum_results_position_flop_BB', {}).get(pos, 0) %}
                {% set pos_total = pos_no_flop + pos_flop %}
                {% set preflop_pct = (pos_no_flop / pos_total * 100) if pos_total != 0 else 0 %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td class="{% if pos_no_flop >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_no_flop) }} BB
                    </td>
                    <td class="{% if pos_flop >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_flop) }} BB
                    </td>
                    <td class="{% if pos_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_total) }} BB</strong>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar {% if preflop_pct >= 50 %}bg-success{% else %}bg-info{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ preflop_pct|abs }}%"
                                 aria-valuenow="{{ preflop_pct|abs }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ "%.1f"|format(preflop_pct) }}%
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h4 class="mb-3">EV by Branch (After You 4-Bet)</h4>
        <table class="table table-bordered table-hover mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Branch</th>
                    <th>Hands</th>
                    <th>Total EV (BB)</th>
                    <th>EV / Hand (BB)</th>
                </tr>
            </thead>
            <tbody>
                {% set fold_branch_4b = branch_ev_4b.get('fold', {}) %}
                {% set call_branch_4b = branch_ev_4b.get('call', {}) %}
                {% set five_bet_branch = branch_ev_4b.get('raise', {}) %}
                <tr>
                    <td>Villain Folds</td>
                    <td>{{ fold_branch_4b.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(fold_branch_4b.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if fold_branch_4b.get('count', 0) > 0 %}
                            {{ "%.2f"|format(fold_branch_4b.get('ev_bb', 0) / fold_branch_4b.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Villain Calls</td>
                    <td>{{ call_branch_4b.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(call_branch_4b.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if call_branch_4b.get('count', 0) > 0 %}
                            {{ "%.2f"|format(call_branch_4b.get('ev_bb', 0) / call_branch_4b.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Villain 5-Bets</td>
                    <td>{{ five_bet_branch.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(five_bet_branch.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if five_bet_branch.get('count', 0) > 0 %}
                            {{ "%.2f"|format(five_bet_branch.get('ev_bb', 0) / five_bet_branch.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% set five_bet_fold = hero_vs_raise_4b.get('fold', {}) %}
                {% set five_bet_call = hero_vs_raise_4b.get('call', {}) %}
                {% set five_bet_jam = hero_vs_raise_4b.get('jam', {}) %}
                {% if five_bet_fold.get('count', 0) or five_bet_call.get('count', 0) or five_bet_jam.get('count', 0) %}
                <tr>
                    <td>Hero Folds vs 5-Bet</td>
                    <td>{{ five_bet_fold.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(five_bet_fold.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if five_bet_fold.get('count', 0) > 0 %}
                            {{ "%.2f"|format(five_bet_fold.get('ev_bb', 0) / five_bet_fold.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Hero Calls vs 5-Bet</td>
                    <td>{{ five_bet_call.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(five_bet_call.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if five_bet_call.get('count', 0) > 0 %}
                            {{ "%.2f"|format(five_bet_call.get('ev_bb', 0) / five_bet_call.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Hero Jams vs 5-Bet</td>
                    <td>{{ five_bet_jam.get('count', 0) }}</td>
                    <td>{{ "%.2f"|format(five_bet_jam.get('ev_bb', 0)) }}</td>
                    <td>
                        {% if five_bet_jam.get('count', 0) > 0 %}
                            {{ "%.2f"|format(five_bet_jam.get('ev_bb', 0) / five_bet_jam.get('count', 1)) }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- Key Insights -->
        <div class="alert alert-info">
            <h5><i class="fas fa-lightbulb"></i> Key Insights:</h5>
            <ul class="mb-0">
                <li><strong>Total 4-Bets:</strong> {{ total_4bets }} ({{ "%.1f"|format(four_bet_opp_rate) if four_bet_opp_rate is not none else "—" }}% of {{ four_bet_opps }} opportunities)</li>
                <li><strong>Villain Response Split:</strong>
                    {% if total_4bets > 0 %}
                        Fold {{ "%.1f"|format((villain_fold_4b / total_4bets) * 100) }}% /
                        Call {{ "%.1f"|format((villain_call_4b / total_4bets) * 100) }}% /
                        5-Bet {{ "%.1f"|format((villain_5bet_4b / total_4bets) * 100) }}%
                    {% else %}
                        —
                    {% endif %}
                </li>
                <li><strong>Biggest Losing Branch:</strong>
                    {% set fold_ev_4b = branch_ev_4b.get('fold', {}).get('ev_bb', 0) %}
                    {% set call_ev_4b = branch_ev_4b.get('call', {}).get('ev_bb', 0) %}
                    {% set five_ev_4b = branch_ev_4b.get('raise', {}).get('ev_bb', 0) %}
                    {% if fold_ev_4b <= call_ev_4b and fold_ev_4b <= five_ev_4b %}Villain Folds{% elif call_ev_4b <= five_ev_4b %}Villain Calls{% else %}Villain 5-Bets{% endif %}
                </li>
                {% if total_4bets < 30 %}
                <li class="text-warning"><strong>Sample size warning:</strong> Fewer than 30 total 4-bets may make percentages noisy.</li>
                {% endif %}
            </ul>
        </div>

        {% if total_4bets == 0 %}
        <div class="alert alert-warning mt-4">
            <i class="fas fa-info-circle"></i> No 4-bets recorded in this session. 4-bet metrics will appear here once you have 4-bet hands.
        </div>
        {% endif %}
    </div>
</div>

<!-- Section 6: Iso-Raise Metrics -->
{% set iso_raise = metrics.get('Iso Raise info', {}) %}
{% set total_iso_raises = iso_raise.get('Num_iso_raises', 0) %}
{% set viable_hands_iso = iso_raise.get('Viable_hands', 1) %}
{% set total_bb_iso = iso_raise.get('Sum_results_BB', 0) %}
{% set avg_bb_iso = iso_raise.get('Avg_result_BB', 0) %}
{% set preflop_wins_iso = iso_raise.get('Num_iso_raise_wins', 0) %}
{% set win_rate_iso = (preflop_wins_iso / total_iso_raises * 100) if total_iso_raises > 0 else 0 %}
{% set iso_raise_freq = (total_iso_raises / viable_hands_iso * 100) if viable_hands_iso > 0 else 0 %}
{% set positions_iso = ['MP', 'CO', 'BTN', 'SB', 'BB'] %}

<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <h2 class="mb-0">6. Iso-Raise Metrics</h2>
        <p class="mb-0"><small>Isolation raises: Raising after players limped (to isolate limpers)</small></p>
    </div>
    <div class="card-body">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-primary">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total Iso-Raises</h5>
                        <h3 class="text-primary">{{ total_iso_raises }}</h3>
                        <small class="text-muted">{{ "%.1f"|format(iso_raise_freq) }}% frequency</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-success">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Preflop Win Rate</h5>
                        <h3 class="text-success">{{ "%.1f"|format(win_rate_iso) }}%</h3>
                        <small class="text-muted">{{ preflop_wins_iso|int }} wins</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center {% if total_bb_iso >= 0 %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Total Profit/Loss</h5>
                        <h3 class="{% if total_bb_iso >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(total_bb_iso) }} BB
                        </h3>
                        <small class="text-muted">All positions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center {% if avg_bb_iso >= 0 %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title text-muted">Avg per Iso-Raise</h5>
                        <h3 class="{% if avg_bb_iso >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(avg_bb_iso) }} BB
                        </h3>
                        <small class="text-muted">Per hand</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Iso-Raise Counts by Position -->
        {% if total_iso_raises > 0 %}
        <h4 class="mb-3">Iso-Raise Frequency by Position</h4>
        <table class="table table-bordered table-hover mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Position</th>
                    <th>Iso-Raises</th>
                    <th>Preflop Wins</th>
                    <th>Win Rate</th>
                    <th>Total BB</th>
                    <th>Avg BB/Iso-Raise</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in positions_iso %}
                {% set pos_iso = iso_raise.get('Num_iso_raises_position', {}).get(pos, 0) %}
                {% set pos_wins = iso_raise.get('Num_iso_raise_wins_position', {}).get(pos, 0) %}
                {% set pos_win_rate = (pos_wins / pos_iso * 100) if pos_iso > 0 else 0 %}
                {% set pos_bb = iso_raise.get('Sum_results_position_BB', {}).get(pos, 0) %}
                {% set pos_avg_bb = (pos_bb / pos_iso) if pos_iso > 0 else 0 %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td>{{ pos_iso|int }}</td>
                    <td>{{ pos_wins|int }}</td>
                    <td>
                        <span class="badge {% if pos_win_rate >= 50 %}bg-success{% elif pos_win_rate >= 40 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ "%.1f"|format(pos_win_rate) }}%
                        </span>
                    </td>
                    <td class="{% if pos_bb >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_bb) }} BB</strong>
                    </td>
                    <td class="{% if pos_avg_bb >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_avg_bb) }} BB
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Profitability Breakdown: Preflop vs Postflop -->
        <h4 class="mb-3">Profitability Breakdown: Preflop vs Postflop</h4>
        <table class="table table-bordered table-hover mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Position</th>
                    <th>Preflop BB</th>
                    <th>Postflop BB</th>
                    <th>Total BB</th>
                    <th>% Preflop</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in positions_iso %}
                {% set pos_no_flop = iso_raise.get('Sum_results_position_no_flop_BB', {}).get(pos, 0) %}
                {% set pos_flop = iso_raise.get('Sum_results_position_flop_BB', {}).get(pos, 0) %}
                {% set pos_total = pos_no_flop + pos_flop %}
                {% set preflop_pct = (pos_no_flop / pos_total * 100) if pos_total != 0 else 0 %}
                <tr>
                    <td><strong>{{ pos }}</strong></td>
                    <td class="{% if pos_no_flop >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_no_flop) }} BB
                    </td>
                    <td class="{% if pos_flop >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ "%.2f"|format(pos_flop) }} BB
                    </td>
                    <td class="{% if pos_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                        <strong>{{ "%.2f"|format(pos_total) }} BB</strong>
                    </td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar {% if preflop_pct >= 50 %}bg-success{% else %}bg-info{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ preflop_pct|abs }}%"
                                 aria-valuenow="{{ preflop_pct|abs }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                {{ "%.1f"|format(preflop_pct) }}%
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Key Insights -->
        <div class="alert alert-info">
            <h5><i class="fas fa-lightbulb"></i> Key Insights:</h5>
            <ul class="mb-0">
                <li><strong>Iso-Raise Frequency:</strong> You're iso-raising {{ "%.1f"|format(iso_raise_freq) }}% of viable hands ({{ total_iso_raises }} out of {{ viable_hands_iso }} hands)</li>
                <li><strong>Fold Equity:</strong> You win {{ "%.1f"|format(win_rate_iso) }}% of iso-raises preflop ({{ preflop_wins_iso|int }} out of {{ total_iso_raises }})</li>
                <li><strong>Overall Profitability:</strong> Your iso-raises are generating {{ "%.2f"|format(total_bb_iso) }} BB total ({{ "%.2f"|format(avg_bb_iso) }} BB per iso-raise on average)</li>
                {% if total_bb_iso < 0 %}
                <li class="text-danger"><strong>Warning:</strong> Your iso-raises are currently unprofitable. Consider adjusting your iso-raising range or improving postflop play.</li>
                {% endif %}
            </ul>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i> No iso-raises recorded in this session. Iso-raise metrics will appear here once you have hands where you raised after players limped.
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var vpipChartEl = document.getElementById('vpipChart');
    if (vpipChartEl) {
        var vpipCtx = vpipChartEl.getContext('2d');
        var vpipChart = new Chart(vpipCtx, {
            type: 'bar',
            data: {
                labels: ['UTG', 'MP', 'CO', 'BTN', 'SB', 'BB'],
                datasets: [{
                    label: 'Player VPIP',
                    data: [{{ metrics.get('VPIP Info', {}).get('positional_vpip', {}).get('UTG', 0) }},
                           {{ metrics.get('VPIP Info', {}).get('positional_vpip', {}).get('MP', 0) }},
                           {{ metrics.get('VPIP Info', {}).get('positional_vpip', {}).get('CO', 0) }},
                           {{ metrics.get('VPIP Info', {}).get('positional_vpip', {}).get('BTN', 0) }},
                           {{ metrics.get('VPIP Info', {}).get('positional_vpip', {}).get('SB', 0) }},
                           {{ metrics.get('VPIP Info', {}).get('positional_vpip', {}).get('BB', 0) }}],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    barThickness: 20  // Make the bars skinnier
                },
                {
                    label: 'Optimal VPIP',
                    data: [null, null, null, null, null, null],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    barThickness: 20  // Make the bars skinnier
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 1,  // Set minimum value to 1
                        max: 100,  // Set maximum value to 100
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    var rfiVpipChartEl = document.getElementById('rfiVpipChart');
    if (rfiVpipChartEl) {
        var rfiVpipCtx = rfiVpipChartEl.getContext('2d');
        var rfiVpipChart = new Chart(rfiVpipCtx, {
            type: 'bar',
            data: {
                labels: ['UTG', 'MP', 'CO', 'BTN', 'SB'],
                datasets: [{
                    label: 'Player RFI VPIP',
                    data: [{{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('UTG', 0) }},
                           {{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('MP', 0) }},
                           {{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('CO', 0) }},
                           {{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('BTN', 0) }},
                           {{ metrics.get('RFI VPIP Info', {}).get('positional_rfi_vpip', {}).get('SB', 0) }}],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    barThickness: 20  // Make the bars skinnier
                },
                {
                    label: 'Optimal RFI VPIP',
                    data: [17.5, 21.5, 30, 45, 42],
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    barThickness: 20  // Make the bars skinnier
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        min: 1,  // Set minimum value to 1
                        max: 100,  // Set maximum value to 100
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Three Bet Frequency Chart
    {% if three_bet.get('Num_three_bets', 0) > 0 %}
    var threeBetFreqCtx = document.getElementById('threeBetFrequencyChart');
    if (threeBetFreqCtx) {
        var threeBetFreqChart = new Chart(threeBetFreqCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['MP', 'CO', 'BTN', 'SB', 'BB'],
                datasets: [{
                    label: '3-Bets',
                    data: [
                        {{ three_bet.get('Num_three_bets_position', {}).get('MP', 0) }},
                        {{ three_bet.get('Num_three_bets_position', {}).get('CO', 0) }},
                        {{ three_bet.get('Num_three_bets_position', {}).get('BTN', 0) }},
                        {{ three_bet.get('Num_three_bets_position', {}).get('SB', 0) }},
                        {{ three_bet.get('Num_three_bets_position', {}).get('BB', 0) }}
                    ],
                    backgroundColor: 'rgba(255, 193, 7, 0.6)',
                    borderColor: 'rgba(255, 193, 7, 1)',
                    borderWidth: 2
                }, {
                    label: 'Preflop Wins',
                    data: [
                        {{ three_bet.get('Num_three_bet_wins_position', {}).get('MP', 0) }},
                        {{ three_bet.get('Num_three_bet_wins_position', {}).get('CO', 0) }},
                        {{ three_bet.get('Num_three_bet_wins_position', {}).get('BTN', 0) }},
                        {{ three_bet.get('Num_three_bet_wins_position', {}).get('SB', 0) }},
                        {{ three_bet.get('Num_three_bet_wins_position', {}).get('BB', 0) }}
                    ],
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }

    // Three Bet Profitability Chart
    var threeBetProfitCtx = document.getElementById('threeBetProfitabilityChart');
    if (threeBetProfitCtx) {
        var threeBetProfitChart = new Chart(threeBetProfitCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['MP', 'CO', 'BTN', 'SB', 'BB'],
                datasets: [{
                    label: 'BB Won/Lost',
                    data: [
                        {{ three_bet.get('Sum_results_position_BB', {}).get('MP', 0) }},
                        {{ three_bet.get('Sum_results_position_BB', {}).get('CO', 0) }},
                        {{ three_bet.get('Sum_results_position_BB', {}).get('BTN', 0) }},
                        {{ three_bet.get('Sum_results_position_BB', {}).get('SB', 0) }},
                        {{ three_bet.get('Sum_results_position_BB', {}).get('BB', 0) }}
                    ],
                    backgroundColor: function(context) {
                        var value = context.parsed.y;
                        return value >= 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)';
                    },
                    borderColor: function(context) {
                        var value = context.parsed.y;
                        return value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)';
                    },
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + ' BB';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'BB: ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}

    var heroToggle = document.getElementById('threeBetViewHero');
    var openerToggle = document.getElementById('threeBetViewOpener');
    var heroTable = document.getElementById('threeBetTableHero');
    var openerTable = document.getElementById('threeBetTableOpener');

    function showHeroView() {
        if (heroTable) heroTable.classList.remove('d-none');
        if (openerTable) openerTable.classList.add('d-none');
        if (heroToggle) heroToggle.classList.add('active');
        if (openerToggle) openerToggle.classList.remove('active');
    }

    function showOpenerView() {
        if (heroTable) heroTable.classList.add('d-none');
        if (openerTable) openerTable.classList.remove('d-none');
        if (heroToggle) heroToggle.classList.remove('active');
        if (openerToggle) openerToggle.classList.add('active');
    }

    if (heroToggle && openerToggle) {
        heroToggle.addEventListener('click', showHeroView);
        openerToggle.addEventListener('click', showOpenerView);
    }

    var fourBetHeroToggle = document.getElementById('fourBetViewHero');
    var fourBetThreeToggle = document.getElementById('fourBetViewThreeBettor');
    var fourBetHeroTable = document.getElementById('fourBetTableHero');
    var fourBetThreeTable = document.getElementById('fourBetTableThreeBettor');

    function showFourBetHeroView() {
        if (fourBetHeroTable) fourBetHeroTable.classList.remove('d-none');
        if (fourBetThreeTable) fourBetThreeTable.classList.add('d-none');
        if (fourBetHeroToggle) fourBetHeroToggle.classList.add('active');
        if (fourBetThreeToggle) fourBetThreeToggle.classList.remove('active');
    }

    function showFourBetThreeBettorView() {
        if (fourBetHeroTable) fourBetHeroTable.classList.add('d-none');
        if (fourBetThreeTable) fourBetThreeTable.classList.remove('d-none');
        if (fourBetHeroToggle) fourBetHeroToggle.classList.remove('active');
        if (fourBetThreeToggle) fourBetThreeToggle.classList.add('active');
    }

    if (fourBetHeroToggle && fourBetThreeToggle) {
        fourBetHeroToggle.addEventListener('click', showFourBetHeroView);
        fourBetThreeToggle.addEventListener('click', showFourBetThreeBettorView);
    }
});


</script>
</br>
</br>
</br>
{% endblock %}
